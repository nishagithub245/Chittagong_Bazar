<?php
include 'db_connection.php';

// Fetch the last saved crop and orientation from DB
$sql = "SELECT * FROM croppedimage ORDER BY id DESC LIMIT 1";
$result = $conn->query($sql);

if ($result && $result->num_rows > 0) {
    $row = $result->fetch_assoc();
    $x1 = $row['x1'];
    $x2 = $row['x2'];
    $y1 = $row['y1'];
    $y2 = $row['y2'];
    $imageorientation = $row['imageorientation']; // 1=0째, 2=90째, 3=180째, 4=270째
} else {
    // Defaults
    $x1 = 50;
    $x2 = 150;
    $y1 = 50;
    $y2 = 150;
    $imageorientation = 1;
}

// Handle form submission
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $x1 = intval($_POST['x1']);
    $x2 = intval($_POST['x2']);
    $y1 = intval($_POST['y1']);
    $y2 = intval($_POST['y2']);
    $imageorientation = intval($_POST['imageorientation']);

    $sql = "INSERT INTO croppedimage (x1, x2, y1, y2, imageorientation)
            VALUES ($x1, $x2, $y1, $y2, $imageorientation)";

    if ($conn->query($sql) !== TRUE) {
        echo "Error: " . $conn->error;
    }

    // Redirect to prevent form resubmission
    header("Location: " . $_SERVER['PHP_SELF']);
    exit();
}

// Convert orientation to rotation degrees for JS
$rotationDegrees = ($imageorientation - 1) * 90;
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chittagong Bazaar - Image Crop & Rotate</title>
<link rel="stylesheet" href="style.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div class="container">

  <div class="left-panel">
    <div class="image-area">
   <div class="imageWrapper" id="imageWrapper">
<img id="utensil-img" src="http://bit.ly/2hRajbp" alt="Cooking utensil set">
<div class="crop-box" id="cropBox"></div>
</div>

     
    </div>

    <div class="thumbnail-preview">
      <h4>Thumbnail preview</h4>
      <div class="thumb-box">
        <img id="thumbImage" src="http://bit.ly/2hRajbp" alt="Thumbnail preview">
      </div>
    </div>
  </div>

  <form method="POST" class="controls" id="cropForm">
    <div class="input-group">
      <input type="number" name="x1" id="x1" value="<?php echo $x1; ?>">
      <label>x1</label>
    </div>

    <div class="input-group">
      <input type="number" name="x2" id="x2" value="<?php echo $x2; ?>">
      <label>x2</label>
    </div>

    <div class="input-group">
      <input type="number" name="y1" id="y1" value="<?php echo $y1; ?>">
      <label>y1</label>
    </div>

    <div class="input-group">
      <input type="number" name="y2" id="y2" value="<?php echo $y2; ?>">
      <label>y2</label>
    </div>

    <div class="rotate-buttons">
      <button type="button" id="rotateLeft">Rotate anticlockwise</button>
      <button type="button" id="rotateRight">Rotate clockwise</button>
    </div>

    <input type="hidden" name="imageorientation" id="imageorientation" value="<?php echo $imageorientation; ?>">

    <button type="submit" class="submit-btn">Submit changes</button>
  </form>

</div>

<script>
// Pass PHP rotation value to JS
let initialRotation = <?php echo $rotationDegrees; ?>;
</script>
<script src="script.js"></script>

</body>
</html>